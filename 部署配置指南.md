# Hajimi King Go - 部署配置指南

## 🚀 快速开始

### 1. 环境要求
- **Go版本**: 1.21 或更高版本
- **操作系统**: Linux, macOS, Windows
- **内存**: 建议 512MB 以上
- **磁盘**: 建议 1GB 以上可用空间

### 2. 获取GitHub Token
1. 访问 [GitHub Settings > Tokens](https://github.com/settings/tokens)
2. 点击 "Generate new token (classic)"
3. 选择 `public_repo` 权限
4. 复制生成的token

## 📦 本地部署

### 方式一：源码编译

#### 1. 克隆项目
```bash
git clone <repository-url>
cd hajimi-king-go
```

#### 2. 安装依赖
```bash
go mod tidy
```

#### 3. 配置环境
```bash
# 复制配置文件
cp .env.example .env
cp queries.example queries.txt

# 编辑配置文件
vim .env
```

#### 4. 配置环境变量
```bash
# 必填配置
GITHUB_TOKENS=ghp_your_token_here_1,ghp_your_token_here_2

# 可选配置
DATA_PATH=./data
DATE_RANGE_DAYS=730
QUERIES_FILE=queries.txt
HAJIMI_CHECK_MODEL=gemini-2.5-flash
API_ENABLED=true
API_PORT=8080
API_AUTH_KEY=your_secure_access_key_here
PROXY=
```

#### 5. 运行程序
```bash
# 直接运行
go run cmd/app/main.go

# 或编译后运行
go build -o hajimi-king cmd/app/main.go
./hajimi-king
```

### 方式二：Docker部署

#### 1. 使用Dockerfile构建
```bash
# 构建镜像
docker build -t hajimi-king-go .

# 运行容器
docker run -d \
  --name hajimi-king-go \
  -p 8080:8080 \
  -e GITHUB_TOKENS=ghp_your_token_here \
  -e API_ENABLED=true \
  -e API_AUTH_KEY=your_secure_key \
  -v $(pwd)/data:/app/data \
  hajimi-king-go
```

#### 2. 使用Docker Compose
```yaml
version: '3.8'
services:
  hajimi-king-go:
    build: .
    container_name: hajimi-king-go
    restart: unless-stopped
    environment:
      - GITHUB_TOKENS=ghp_your_token_here_1,ghp_your_token_here_2
      - API_ENABLED=true
      - API_PORT=8080
      - API_AUTH_KEY=your_secure_access_key_here
      - DATA_PATH=/app/data
      - DATE_RANGE_DAYS=730
    volumes:
      - ./data:/app/data
      - ./queries.txt:/app/queries.txt
    ports:
      - "8080:8080"
    working_dir: /app
```

## ⚙️ 详细配置

### 1. 环境变量配置

#### 必填配置
| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `GITHUB_TOKENS` | GitHub API访问令牌，多个用逗号分隔 | `ghp_token1,ghp_token2` |

#### 重要配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `PROXY` | 空 | 代理服务器地址，支持多个（逗号分隔） |
| `DATA_PATH` | `./data` | 数据存储目录路径 |
| `DATE_RANGE_DAYS` | `730` | 仓库年龄过滤（天数） |
| `QUERIES_FILE` | `queries.txt` | 搜索查询配置文件路径 |
| `HAJIMI_CHECK_MODEL` | `gemini-2.5-flash` | 用于验证key有效的模型 |
| `API_ENABLED` | `false` | 是否启用API服务器和Web界面 |
| `API_PORT` | `8080` | API服务器端口 |
| `API_AUTH_KEY` | 空 | API访问密钥（设置后需要登录才能访问） |

#### 外部服务配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `GEMINI_BALANCER_SYNC_ENABLED` | `false` | 是否启用Gemini Balancer同步 |
| `GEMINI_BALANCER_URL` | 空 | Gemini Balancer服务地址 |
| `GEMINI_BALANCER_AUTH` | 空 | Gemini Balancer认证信息 |
| `GPT_LOAD_SYNC_ENABLED` | `false` | 是否启用GPT Load Balancer同步 |
| `GPT_LOAD_URL` | 空 | GPT Load 服务地址 |
| `GPT_LOAD_AUTH` | 空 | GPT Load 认证Token |
| `GPT_LOAD_GROUP_NAME` | 空 | GPT Load 组名，多个用逗号分隔 |

#### 高级配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `VALID_KEY_PREFIX` | `keys/keys_valid_` | 有效密钥文件名前缀 |
| `RATE_LIMITED_KEY_PREFIX` | `keys/key_429_` | 频率限制密钥文件名前缀 |
| `KEYS_SEND_PREFIX` | `keys/keys_send_` | 发送到外部应用的密钥文件名前缀 |
| `VALID_KEY_DETAIL_PREFIX` | `logs/keys_valid_detail_` | 详细日志文件名前缀 |
| `RATE_LIMITED_KEY_DETAIL_PREFIX` | `logs/key_429_detail_` | 频率限制详细日志文件名前缀 |
| `SCANNED_SHAS_FILE` | `scanned_shas.txt` | 已扫描文件SHA记录文件名 |
| `FILE_PATH_BLACKLIST` | `readme,docs,...` | 文件路径黑名单，逗号分隔 |

### 2. 查询配置文件

#### 文件位置
- 默认路径: `queries.txt`
- 可通过 `QUERIES_FILE` 环境变量修改

#### 配置格式
```bash
# GitHub搜索查询配置文件
# 每行一个查询语句，支持GitHub搜索语法
# 以#开头的行为注释，空行会被忽略

# 基础搜索
AIzaSy in:file

# 环境文件搜索
AIzaSy in:file filename:.env

# Python文件搜索
AIzaSy in:file language:python

# 配置文件搜索
AIzaSy in:file path:config

# 组合搜索
AIzaSy in:file language:python filename:config.py
```

#### 搜索语法参考
- **基础搜索**: `AIzaSy` - 搜索包含AIzaSy的代码
- **文件类型**: `filename:.env` - 搜索.env文件
- **语言过滤**: `language:python` - 搜索Python代码
- **路径过滤**: `path:config` - 搜索config目录
- **组合查询**: 多个条件用空格分隔

## 🌐 代理配置

### 1. 代理类型支持
- **HTTP代理**: `http://proxy:port`
- **HTTPS代理**: `https://proxy:port`
- **SOCKS5代理**: `socks5://proxy:port`

### 2. 代理认证
```bash
# 用户名密码认证
PROXY=http://username:password@proxy:8080

# 多个代理（逗号分隔）
PROXY=http://proxy1:8080,http://proxy2:8080,socks5://proxy3:1080
```

### 3. 推荐代理方案
- **WARP代理**: [warp-docker](https://github.com/cmj2002/warp-docker)
- **本地代理**: 使用本地代理软件
- **云代理**: 使用云服务商提供的代理

## 🔧 高级配置

### 1. 性能调优
```bash
# 调整扫描范围
DATE_RANGE_DAYS=365  # 只扫描一年内的仓库

# 调整API模型
HAJIMI_CHECK_MODEL=gemini-2.5-flash  # 使用更快的模型

# 调整文件过滤
FILE_PATH_BLACKLIST=readme,docs,test,example,sample
```

### 2. 安全配置
```bash
# 启用API认证
API_AUTH_KEY=your_very_secure_password_here

# 限制API端口
API_PORT=8080

# 设置数据目录权限
DATA_PATH=/secure/data/path
```

### 3. 外部服务集成
```bash
# Gemini Balancer集成
GEMINI_BALANCER_SYNC_ENABLED=true
GEMINI_BALANCER_URL=https://your-balancer.com
GEMINI_BALANCER_AUTH=your_auth_token

# GPT Load Balancer集成
GPT_LOAD_SYNC_ENABLED=true
GPT_LOAD_URL=https://your-gpt-load.com
GPT_LOAD_AUTH=your_bearer_token
GPT_LOAD_GROUP_NAME=group1,group2,group3
```

## 📊 监控和维护

### 1. 日志文件
```bash
# 查看实时日志
tail -f data/logs/keys_valid_detail_*.log

# 查看错误日志
grep "ERROR" data/logs/*.log

# 查看统计信息
grep "Found.*key" data/logs/*.log
```

### 2. 数据文件
```bash
# 查看有效密钥
cat data/keys/keys_valid_*.txt

# 查看限流密钥
cat data/keys/key_429_*.txt

# 查看检查点
cat data/scanned_shas.txt
```

### 3. 性能监控
```bash
# 检查内存使用
ps aux | grep hajimi-king

# 检查网络连接
netstat -an | grep :8080

# 检查磁盘使用
du -sh data/
```

## 🚨 故障排除

### 1. 常见问题

#### GitHub API限制
```bash
# 症状: 频繁出现403/429错误
# 解决: 增加更多GitHub Token
GITHUB_TOKENS=token1,token2,token3,token4
```

#### 代理连接失败
```bash
# 症状: 网络连接超时
# 解决: 检查代理配置
PROXY=http://working-proxy:8080
```

#### 密钥验证失败
```bash
# 症状: 所有密钥都显示无效
# 解决: 检查Gemini API配置
HAJIMI_CHECK_MODEL=gemini-2.5-flash
```

#### Web界面无法访问
```bash
# 症状: 无法打开Web界面
# 解决: 检查API配置
API_ENABLED=true
API_PORT=8080
```

### 2. 调试模式
```bash
# 启用详细日志
export LOG_LEVEL=DEBUG

# 检查配置
./hajimi-king --check-config

# 测试连接
./hajimi-king --test-connections
```

### 3. 数据恢复
```bash
# 从检查点恢复
# 检查点文件: data/scanned_shas.txt
# 删除检查点文件可重新开始扫描

# 清理旧数据
rm -rf data/keys/keys_valid_*.txt
rm -rf data/logs/keys_valid_detail_*.log
```

## 🔄 更新和维护

### 1. 程序更新
```bash
# 停止程序
pkill hajimi-king

# 备份数据
cp -r data data_backup_$(date +%Y%m%d)

# 更新代码
git pull origin main

# 重新编译
go build -o hajimi-king cmd/app/main.go

# 启动程序
./hajimi-king
```

### 2. 数据备份
```bash
# 创建备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf hajimi_king_backup_$DATE.tar.gz data/
```

### 3. 定期维护
```bash
# 清理旧日志（保留30天）
find data/logs/ -name "*.log" -mtime +30 -delete

# 清理旧密钥文件（保留7天）
find data/keys/ -name "*.txt" -mtime +7 -delete

# 压缩检查点文件
gzip data/scanned_shas.txt
```

## 📋 部署检查清单

### 部署前检查
- [ ] Go环境已安装（版本1.21+）
- [ ] GitHub Token已获取并配置
- [ ] 网络连接正常
- [ ] 磁盘空间充足（>1GB）
- [ ] 防火墙端口已开放（8080）

### 配置检查
- [ ] 环境变量配置正确
- [ ] 查询文件格式正确
- [ ] 代理配置（如需要）
- [ ] 外部服务配置（如需要）

### 运行检查
- [ ] 程序启动无错误
- [ ] Web界面可正常访问
- [ ] API接口响应正常
- [ ] 日志输出正常
- [ ] 密钥搜索功能正常

### 监控检查
- [ ] 统计信息更新正常
- [ ] 日志文件正常生成
- [ ] 数据文件正常保存
- [ ] 外部同步正常（如配置）

这个部署配置指南提供了完整的部署和配置说明，帮助用户快速上手并正确配置Hajimi King Go系统。